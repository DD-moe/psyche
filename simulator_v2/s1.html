<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Przepytam CiÄ™ ze Skali Glasgow</title>
  <link rel="stylesheet" href="https://git.1ioe.top/psyche/simulator_v2/styles.css">


</head>
<body>
  <h1>Przepytam CiÄ™ ze Skali ASA</h1>
  <label for="token">Token (API Key):</label>
  <input type="password" id="token" placeholder="WprowadÅº swÃ³j token...">
  <hr>

  <button id="generateBtn">Generuj przypadek</button>
  <div id="loadingSpinner" style="display:none; text-align:center; margin: 10px;">
    <span style="display:inline-block; width:24px; height:24px; border:4px solid #ccc; border-top-color:#005691; border-radius:50%; animation: spin 1s linear infinite;"></span>
  </div>  
  <p><strong>Wygenerowany przypadek:</strong></p>
  <pre id="caseOutput">[Brak przypadku]</pre>

  <hr>
      <p>Podaj ile punktÃ³w w skali ASA ma dany pacjent</p>
  <hr>

  <label for="userInput">Napisz odpowiedÅº:</label><br>
  <textarea id="userInput" rows="10" cols="80"></textarea><br>

  <button id="evaluateBtn">OceÅ„</button>
  <div id="evaluatingSpinner" style="display:none; text-align:center; margin: 10px;">
    <span style="display:inline-block; width:24px; height:24px; border:4px solid #ccc; border-top-color:#005691; border-radius:50%; animation: spin 1s linear infinite;"></span>
  </div>  
  <p><strong>Ocena AI:</strong></p>
  <pre id="evaluationOutput">[Brak oceny]</pre>
</body>

<script>
// definicja skali do odpytania
const definicja = `I â€“ pacjent do 60. r.Å¼., nieobciÄ…Å¼ony chorobami, poddany maÅ‚emu lub Å›redniemu zabiegowi operacyjnemu,
II â€“ pacjent powyÅ¼ej 65. r.Å¼., bez chorÃ³b wspÃ³Å‚istniejÄ…Â­cych lub mÅ‚odszy ze schorzeniem, ktÃ³re nie wpÅ‚ywa na jego stan ogÃ³lny, z niezbyt nasilonÄ… chorobÄ… ukÅ‚adowÄ…, takÄ… jak: stabilne i dobrze kontrolowane nadciÅ›nienie tÄ™tnicze, wyrÃ³wnana cukrzyca, przewlekÅ‚e zapalenie oskrzeli w stadium wydolnoÅ›ci ukÅ‚adu oddechowego, niewielkiego stopnia choroba niedokrwienna miÄ™Å›nia sercowego, niedokrwistoÅ›Ä‡, znacznego stopnia otyÅ‚oÅ›Ä‡ (powyÅ¼ej 20% naleÅ¼nej masy ciaÅ‚a),
III â€“ pacjent ze wspÃ³Å‚istniejÄ…cÄ… powaÅ¼nÄ… choroba ukÅ‚adowÄ…, ktÃ³rej zaawansowanie ogranicza jego wydolnoÅ›Ä‡ lub aktywnoÅ›Ä‡, ale nie stwarza zagroÅ¼enia dla Å¼ycia, np. przebyty zawaÅ‚ serca do 3 miesiÄ™cy przed datÄ… wykonania zabiegu operacyjnego, niestabilna dusznica bolesna, ciÄ™Å¼kie schorzenie ukÅ‚adu oddechowego, nieuregulowana cukrzyca,
IV â€“ pacjent z bardzo ciÄ™Å¼kÄ… chorobÄ… ukÅ‚adowÄ…, ktÃ³ra zagraÅ¼a jego Å¼yciu, np. niewydolnoÅ›Ä‡ nerek, zastoinowa niewydolnoÅ›Ä‡ krÄ…Å¼enia, organiczna wada serca z cechami ostrej niewydolnoÅ›ci krÄ…Å¼enia, Å›wieÅ¼y zawaÅ‚ miÄ™Å›nia sercowego, niewydolnoÅ›Ä‡ wÄ…troby, gruczoÅ‚Ã³w dokrewnych,
V â€“ pacjent w stanie krytycznym, ktÃ³rego przewidywany czas przeÅ¼ycia nie przekracza 24 godzin, pacjent z niewydolnoÅ›ciÄ… wielonarzÄ…dowÄ…, w stanie skrajnie ciÄ™Å¼kim, u ktÃ³rego z duÅ¼ym prawdopodobieÅ„stwem zgon nastÄ…pi w ciÄ…gu 24 godzin, bez wzglÄ™du na to, czy zostanie poddany zabiegowi operacyjnemu, czy teÅ¼ nie (np. pacjent z pÄ™kniÄ™tym tÄ™tniakiem aorty i gÅ‚Ä™bokim wstrzÄ…sem, pacjent z masywnym zatorem tÄ™tnicy pÅ‚ucnej).
VI - pacjent nie Å¼yje - podtrzymywane funkcje Å¼yciowe jako potencjalny dawca narzÄ…dÃ³w
`;

// wygenerowany przypadek
let lastCase = '';
</script>

<script type="module">

  // importuje bibliotekÄ™ z google
  import { GoogleGenAI } from "https://esm.run/@google/genai";

  // funkcja do odpytywania AI
  async function main(prompt, instruction, token) {
    const ai = new GoogleGenAI({ apiKey: token });

    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: prompt,
      config: {
        systemInstruction: instruction,
      },
    });

    return response.text || "[Brak odpowiedzi]";
  }

  // funkcja do losowania liczb csÅ‚kowitych w zakresie
  function ll(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  // przycisk do generowania przypadku
    document.getElementById('generateBtn').addEventListener('click', async () => {
    const token = document.getElementById('token').value.trim();
    if (!token) {
      alert("Podaj token API!");
      return;
    }
    const nr = ll(1,6);
    const instruction = `Wygeneruj na podstawie definicji ASA krÃ³tki opis pacjenta. maksymalnie 2 zdania. wygeneruj opis tak, by pacjent kwalifikowaÅ‚ siÄ™ do kategorii ASA: ${nr}`;
    console.log(nr);
    const prompt = definicja;

    try {
      ss('loadingSpinner');        
      lastCase = await main(prompt, instruction, token);
      document.getElementById('caseOutput').textContent = formatResponse(lastCase);
    } catch (err) {
      document.getElementById('caseOutput').textContent = "BÅ‚Ä…d: " + err.message;
    }
    finally{
      hs('loadingSpinner');
    }    
  });

  // prcycisk do oceny przez AI
    document.getElementById('evaluateBtn').addEventListener('click', async () => {
    const token = document.getElementById('token').value.trim();
    if (!token) {
      alert("Podaj token API!");
      return;
    }

    const userText = document.getElementById('userInput').value;
    const evaluationInstruction = "OceÅ„, czy uÅ¼ytkownik poprawnie podaÅ‚ stan pacjenta w skali ASA - podaje numer. W razie niepoprawnoÅ›ci podaj poprawnÄ… odpowiedÅº i wyjaÅ›nienie.";
    const schema = definicja;
    const prompt = `Opis pacjenta: ${userText}\n\nDefinicja Skali ASA: ${schema}\n\nPrzypadek: ${lastCase}`;

    try {
      ss('evaluatingSpinner');
      const result = await main(prompt, evaluationInstruction, token);
      document.getElementById('evaluationOutput').textContent = formatResponse(result);
    } catch (err) {
      document.getElementById('evaluationOutput').textContent = "BÅ‚Ä…d: " + err.message;
    }
    finally{
      hs('evaluatingSpinner');
    }
  });

  // funkcja do formatowania odpowiedzi
    function formatResponse(input) {
    // ZamieÅ„ podwÃ³jne gwiazdki na duÅ¼e litery lub styl ASCII
    let output = input
        .replace(/\*\*(.*?)\*\*/g, (match, p1) => p1.toUpperCase()) // **tekst** â†’ TEKST
        .replace(/\*   /g, "- ") // ZamieÅ„ wypunktowanie Markdown na myÅ›lniki
        .replace(/^\s*\n/gm, "") // UsuÅ„ puste linie

    // Dodaj wciÄ™cia i uporzÄ…dkuj
    return output.split('\n').map(line => '  ' + line.trim()).join('\n');
    }

function ss(p){
  document.getElementById(p).style.display = 'block'; // ğŸ”¹ PokaÅ¼ spinner
}

function hs(p){
  document.getElementById(p).style.display = 'none'; // ğŸ”» Ukryj spinner
}
</script>
</html>