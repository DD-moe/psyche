<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Interaktywny Obraz z Punktami</title>
  <style>
    /* Body */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f0f2f5;
  margin: 0;
  padding: 20px;
  text-align: center;
  color: #333;
}

/* Nagłówki */
h2, h3 {
  color: #222;
  margin-bottom: 15px;
}

/* Obraz */
img {
  max-width: 90%;
  height: auto;
  display: block;
  margin: 20px auto;
  border-radius: 12px;
  border: 2px solid #ccc;
  box-shadow: 0 6px 15px rgba(0,0,0,0.1);
  cursor: crosshair;
  transition: transform 0.2s ease;
}

img:hover {
  transform: scale(1.02);
}

/* Formularze i textarea */
textarea, input[type="text"], input[type="number"] {
  width: 90%;
  margin: 10px auto;
  padding: 8px 12px;
  border: 1px solid #ccc;
  border-radius: 8px;
  display: block;
  font-size: 1rem;
  box-sizing: border-box;
  transition: border 0.2s ease, box-shadow 0.2s ease;
}

textarea:focus, input:focus {
  border-color: #4CAF50;
  box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
  outline: none;
}

/* Status */
#status {
  margin: 15px auto 0 auto;
  font-weight: bold;
  white-space: pre-wrap;
  background: #fff;
  padding: 10px 15px;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  max-width: 90%;
}

/* Panel sterowania */
.controls {
  margin: 20px auto;
  padding: 15px 20px;
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 6px 15px rgba(0,0,0,0.08);
  display: none;
  text-align: left;
  max-width: 600px;
}

/* Checkboxy i labelki */
.controls label {
  display: inline-block;
  margin: 10px 0;
  font-size: 0.95rem;
}

/* Przycisk toggle */
#toggleControlsBtn {
  font-size: 1.6rem;          
  background: #4CAF50;        
  border: none;               
  border-radius: 12px;        
  padding: 10px 20px;         
  cursor: pointer;            
  box-shadow: 0 4px 6px rgba(0,0,0,0.2); 
  transition: all 0.2s ease;  
  margin-bottom: 15px;
}

#toggleControlsBtn:hover {
  background: #45a049;       
  transform: scale(1.1);     
}

#toggleControlsBtn:active {
  transform: scale(0.95);    
  box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
}

/* Pozostałe przyciski */
button {
  background: #1976d2;
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 8px 15px;
  margin: 5px 2px;
  cursor: pointer;
  font-size: 1rem;
  transition: all 0.2s ease;
}

button:hover {
  background: #115293;
  transform: translateY(-2px);
}

button:active {
  transform: translateY(1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}


  </style>
</head>
<body>

  <button id="toggleControlsBtn">Pokaż/Ukryj opcje</button>

  <div class="controls" id="controlsDiv">
    <label for="addPointMode"> Dodaj punkt: </label>
    <input type="checkbox" id="addPointMode">
    <br>
    <label for="pointNameInput">Nazwa punktu: </label>
    <input type="text" id="pointNameInput" placeholder="np. Punkt A">

    <label for="searchRadiusInput">Zasięg wyszukiwania (px): </label>
    <input type="number" id="searchRadiusInput" value="20" min="1">

    <textarea id="pointParamsInput" placeholder="Tutaj wpisz parametry punktu (np. height: 13)"></textarea>
    
    <textarea id="jsonInput" placeholder="Wklej tutaj JSON..."></textarea><br>
    <button id="loadJsonBtn">Załaduj JSON (nadpisz)</button>
    <button id="appendJsonBtn">Dodaj JSON do istniejących</button>
    <button id="exportJsonBtn">Punkty do JSON</button>
    <button id="chooseImageBtn">Wybierz obraz</button>
    <input type="file" id="fileInput" accept="image/*" style="display:none">

    <div id="status"></div>
  </div>

  <img id="image" src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a9/Example.jpg/800px-Example.jpg" alt="Kliknij na obraz" />

  <script>
    const image = document.getElementById('image');
    const jsonInput = document.getElementById('jsonInput');
    const loadJsonBtn = document.getElementById('loadJsonBtn');
    const appendJsonBtn = document.getElementById('appendJsonBtn');
    const exportJsonBtn = document.getElementById('exportJsonBtn');
    const statusDiv = document.getElementById('status');
    const addPointModeCheckbox = document.getElementById('addPointMode');
    const pointNameInput = document.getElementById('pointNameInput');
    const pointParamsInput = document.getElementById('pointParamsInput');
    const toggleControlsBtn = document.getElementById('toggleControlsBtn');
    const controlsDiv = document.getElementById('controlsDiv');
    const searchRadiusInput = document.getElementById('searchRadiusInput');
    const chooseImageBtn = document.getElementById('chooseImageBtn');
    const fileInput = document.getElementById('fileInput');

    let pointsArray = []; // stores all points searched when clicked
    const bc = new BroadcastChannel("Main_channel");
    const hash = window.location.hash.substring(1); // usuwa #
    const params = new URLSearchParams(hash);
    const iframeName = params.get('iframeName');
    const managerName = params.get('managerName');


    // ładowanie własnego obrazu
    chooseImageBtn.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;

      // Odczyt pliku jako dataURL
      const reader = new FileReader();
      reader.onload = (e) => {
        const dataUrl = e.target.result;

        // Podgląd w managerze
        image.src = dataUrl;

        // Wysyłanie przez BroadcastChannel
        bc.postMessage({
          target: managerName,
          from: iframeName,
          task: "loaded image",
          content: dataUrl // base64 obraz
        });

        console.log("Wysłano obraz do iframe:", iframeName);
      };
      reader.readAsDataURL(file);
    });

    // Toggle widoczności panelu
    toggleControlsBtn.addEventListener('click', () => {
      toggleSettings();
    });

    // API do zmiany widoczności
    function toggleSettings(){
      controlsDiv.style.display = (controlsDiv.style.display === "none" ? "block" : "none");
    }

    // zmiana zasięgu szukania
    searchRadiusInput.addEventListener('change', () =>{
      bc.postMessage({target: managerName, from: iframeName, task: 'set search range', content: parseFloat(searchRadiusInput.value)});
    });

    // set range API
    function setRange(range){
      searchRadiusInput.value = range;
    }

    // Załaduj JSON (nadpisuje)
    loadJsonBtn.addEventListener('click', () => {
        loadPoints(jsonInput.value);
    });

    // API do ładowania JSON
    function loadPoints(json){
      try {
        const parsed = JSON.parse(json);
        if (!Array.isArray(parsed)) throw new Error("JSON musi być tablicą.");
        pointsArray = parsed;
        statusDiv.textContent = "Załadowano punkty (nadpisano): " + pointsArray.length;
        statusDiv.style.color = "green";
      } catch (e) {
        statusDiv.textContent = "Błąd: " + e.message;
        statusDiv.style.color = "red";
      }
    }

    // Dodaj JSON do istniejących
    appendJsonBtn.addEventListener('click', () => {
      addPoints(jsonInput.value);
    });

    // API do dokładania punktów
    function addPoints(json){
        try {
        const parsed = JSON.parse(json);
        if (!Array.isArray(parsed)) throw new Error("JSON musi być tablicą.");
        pointsArray = pointsArray.concat(parsed);
        statusDiv.textContent = "Dodano punkty. Razem teraz: " + pointsArray.length;
        statusDiv.style.color = "darkorange";
      } catch (e) {
        statusDiv.textContent = "Błąd: " + e.message;
        statusDiv.style.color = "red";
      }
    }

    // Eksportuj JSON
    exportJsonBtn.addEventListener('click', () => {
      const points = ExportPoints();
      bc.postMessage({target: managerName, from: iframeName, task: 'export points', content: points});
    });

    // Api do eksportowania do JSON
    function ExportPoints(){
      const json = JSON.stringify(pointsArray, null, 2);
      jsonInput.value = json;
      statusDiv.textContent = "Wyeksportowano punkty do JSON";
      statusDiv.style.color = "blue";
      return json;
    }

    // Kliknięcie na obraz
    image.addEventListener('click', (e) => {
      const rect = image.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickY = e.clientY - rect.top;
      const scaleX = image.naturalWidth / rect.width;
      const scaleY = image.naturalHeight / rect.height;
      const imageX = clickX * scaleX;
      const imageY = clickY * scaleY;

      if (addPointModeCheckbox.checked) {
        const pointName = pointNameInput.value.trim() || `Punkt`;

        // Parsowanie parametrów
        let params = {};
        const lines = pointParamsInput.value.trim().split("\n").filter(l => l.trim() !== "");
        for (const line of lines) {
          const [key, value] = line.split(":").map(s => s.trim());
          if (key) {
            try {
              params[key] = JSON.parse(value);
            } catch {
              params[key] = value;
            }
          }
        }

        const newPoint = {
          name: pointName,
          x: Math.round(imageX),
          y: Math.round(imageY),
          params: params
        };
        pointsArray.push(newPoint);
        statusDiv.textContent = `Dodano punkt: ${newPoint.name} (${newPoint.x}, ${newPoint.y})`;
        statusDiv.style.color = "darkorange";
      } else {
        const radius = parseFloat(searchRadiusInput.value) || 20;
        const foundPoints = [];
        for (const point of pointsArray) {
          const dx = point.x - imageX;
          const dy = point.y - imageY;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist <= radius) {
            foundPoints.push(point);
          }
        }

        // Emitujemy event z listą punktów
        const event = new CustomEvent("clickedPoints", { detail: foundPoints });
        document.dispatchEvent(event);
      }
    });

    // Odbiornik eventu clickedPoints
    document.addEventListener("clickedPoints", (e) => {
      const points = e.detail;
      if (points.length === 0) {
        statusDiv.textContent = "Nie znaleziono żadnych punktów w zasięgu.";
        statusDiv.style.color = "red";
      } else {
        let out = "Znalezione punkty:\n";
        for (const p of points) {
          out += `- ${p.name} (${p.x}, ${p.y})\n   ${JSON.stringify(p.params)}\n`;
        }
        statusDiv.textContent = out;
        statusDiv.style.color = "green";
        bc.postMessage({target: managerName, from: iframeName, task: 'clicked points', content: points});
      }
    });

    bc.onmessage = (event) => {
      const msg = event.data;
      if (!msg || typeof msg !== "object") return;
      if (msg.target !== iframeName || !("from" in msg) || !("task" in msg) || !("content" in msg)) return;

      switch (msg.task) {
        case "set points":
          loadPoints(msg.content);
          break;

        case "set image":
          image.src = msg.content;
          break;

        case "export points":
          bc.postMessage({target: managerName, from: iframeName, task: 'export points', content: ExportPoints()});
          break;

        case "set range":
          setRange(msg.content);
          break;

        default:
          console.warn("Nieznane zadanie:", msg.task);
      }
    };


  </script>
</body>
</html>
