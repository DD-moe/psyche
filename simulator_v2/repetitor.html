<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Text-to-Speech & SpeechRecognition</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --accent:#4f46e5;
      --muted:#6b7280;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{
      margin:0; min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg,var(--bg),#eef2ff 100%);
      padding:24px;
    }
    .card{
      width:100%; max-width:820px;
      background:var(--card); border-radius:12px;
      box-shadow: 0 6px 24px rgba(15,23,42,0.08);
      padding:20px;
    }
    h1{ margin:0 0 8px; font-size:20px; }
    p.lead{ margin:0 0 18px; color:var(--muted); font-size:14px; }
    label{ display:block; font-size:13px; margin-bottom:6px; color:#111827; }
    select, textarea, input[type="range"], input[type="text"]{ width:100%; }
    textarea.txt{ min-height:140px; resize:vertical; padding:10px; border-radius:8px; border:1px solid #e6e9ef; font-size:14px; line-height:1.4; }
    .controls{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .small{ font-size:13px; color:var(--muted); }
    .btn{ padding:8px 14px; border-radius:8px; border:0; cursor:pointer; background:var(--accent); color:white; font-weight:600; }
    .btn.ghost{ background:transparent; color:var(--accent); border:1px solid rgba(79,70,229,0.2); }
    .speakers{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .speaker-btn{ padding:6px 12px; border-radius:8px; border:1px solid #ddd; cursor:pointer; background:#f9fafb; }
    .speaker-btn.active{ background:var(--accent); color:white; border-color:var(--accent); }
    footer{ margin-top:14px; color:var(--muted); font-size:12px; text-align:right; }
    @media (max-width:640px){ .controls{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <main class="card">
    <h1>Text-to-Speech + Rozpoznawanie mowy</h1>
    <p class="lead">Wpisz tekst lub u≈ºyj mikrofonu do rozpoznawania mowy.</p>

    <form id="speech-form">
      <div class="control-group">
        <label for="voiceSelect">G≈Ços</label>
        <select id="voiceSelect"></select>
      </div>

      <div class="control-group">
        <label for="textInput">Tekst do wypowiedzenia</label>
        <textarea id="textInput" class="txt" placeholder="Tutaj pojawi siƒô tekst..."></textarea>
      </div>

      <div class="controls">
        <div>
          <label for="pitch">Pitch <span class="pitch-value small">1</span></label>
          <input id="pitch" type="range" min="0" max="2" step="0.1" value="1" />
        </div>
        <div>
          <label for="rate">Szybko≈õƒá <span class="rate-value small">1</span></label>
          <input id="rate" type="range" min="0.5" max="2" step="0.1" value="1" />
        </div>
      </div>

      <div class="row">
        <button type="submit" class="btn">M√≥w</button>
        <button type="button" id="cancelBtn" class="btn ghost">Anuluj mowƒô</button>
      </div>

      <hr style="margin:16px 0;">

      <div class="control-group">
        <label for="speakersInput">Lista speaker√≥w (po przecinku)</label>
        <input type="text" id="speakersInput" placeholder="np. Anna, Jan, Piotr" />
        <div class="speakers" id="speakersList"></div>
      </div>
      <div class="control-group">
        <label for="modelSelect">Model Gemini</label>
        <select id="modelSelect">
          <option value="gemini-2.5-flash-lite">gemini 2.5 flash lite</option>
          <option value="gemini-2.0-flash-lite">gemini 2.0 flash lite</option>
          <option value="models/gemma-3n-e4b-it">gemma 3n e4b</option>
        </select>
          <label for="token">Token (API Key):</label>
          <input type="password" id="token" placeholder="Wprowad≈∫ sw√≥j token...">
      </div>
      <div class="row">
        <button type="button" id="startRec" class="btn">üé§ Start nagrywania</button>
        <button type="button" id="stopRec" class="btn ghost">‚èπ Zatrzymaj</button>
        <button type="button" id="answerBtn" class="btn">ü§ñ Odpowiedz (Gemini)</button>
      </div>
    </form>

    <footer>Web Speech API (TTS & STT) ¬∑ Dzia≈Ça tylko w obs≈Çugiwanych przeglƒÖdarkach (np. Chrome)</footer>
  </main>

  <script>
    // === SYNTEZA MOWY (TTS) ===
    const synth = window.speechSynthesis;
    const inputForm = document.querySelector("form");
    const inputTxt = document.querySelector(".txt");
    const voiceSelect = document.querySelector("select");
    const pitch = document.querySelector("#pitch");
    const pitchValue = document.querySelector(".pitch-value");
    const rate = document.querySelector("#rate");
    const rateValue = document.querySelector(".rate-value");
    const cancelBtn = document.getElementById("cancelBtn");

    let voices = [];
    function populateVoiceList() {
      voices = synth.getVoices();
      voiceSelect.innerHTML = "";
      for (const voice of voices) {
        const option = document.createElement("option");
        option.textContent = `${voice.name} (${voice.lang})`;
        if (voice.default) option.textContent += " ‚Äî DOMY≈öLNY";
        option.setAttribute("data-name", voice.name);
        voiceSelect.appendChild(option);
      }
    }
    populateVoiceList();
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = populateVoiceList;
    }

    function updatePitchDisplay(){ pitchValue.textContent = pitch.value; }
    function updateRateDisplay(){ rateValue.textContent = rate.value; }
    pitch.addEventListener("input", updatePitchDisplay);
    rate.addEventListener("input", updateRateDisplay);
    updatePitchDisplay(); updateRateDisplay();

    inputForm.onsubmit = (e) => {
      e.preventDefault();
      if (!inputTxt.value.trim()) return;
      const utterThis = new SpeechSynthesisUtterance(inputTxt.value);
      const selectedOption = voiceSelect.selectedOptions[0]?.getAttribute("data-name");
      if (selectedOption){
        const v = voices.find(v=>v.name===selectedOption);
        if (v) utterThis.voice = v;
      }
      utterThis.pitch = parseFloat(pitch.value);
      utterThis.rate = parseFloat(rate.value);
      synth.speak(utterThis);
      inputTxt.blur();
    };
    cancelBtn.onclick = ()=> synth.cancel();

    // === LISTA SPEAKER√ìW ===
    const speakersInput = document.getElementById("speakersInput");
    const speakersList = document.getElementById("speakersList");
    let activeSpeaker = null;

    function renderSpeakers(){
      speakersList.innerHTML = "";
      const names = speakersInput.value.split(",").map(n=>n.trim()).filter(Boolean);
      names.forEach(name=>{
        const btn = document.createElement("button");
        btn.type="button";
        btn.textContent = name;
        btn.className = "speaker-btn";
        btn.onclick = ()=>{
          // toggle active
          document.querySelectorAll(".speaker-btn").forEach(b=>b.classList.remove("active"));
          if (activeSpeaker===name){
            activeSpeaker=null;
          } else {
            btn.classList.add("active");
            activeSpeaker=name;
          }
        };
        speakersList.appendChild(btn);
      });
    }
    speakersInput.addEventListener("input", renderSpeakers);

    // === ROZPOZNAWANIE MOWY (STT) ===
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition){
      recognition = new SpeechRecognition();
      recognition.lang = "pl-PL";
      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.onresult = (event)=>{
        const transcript = event.results[event.results.length-1][0].transcript.trim();
        if (activeSpeaker){
          inputTxt.value += (inputTxt.value ? "\n" : "") + activeSpeaker + ": " + transcript;
        } else {
          inputTxt.value += (inputTxt.value ? "\n" : "") + transcript;
        }
      };
      recognition.onerror = (e)=> console.error("B≈ÇƒÖd rozpoznawania:", e.error);
    }

    document.getElementById("startRec").onclick = ()=>{
      if (recognition){
        recognition.start();
        console.log("Rozpoznawanie mowy: START");
      }
    };
    document.getElementById("stopRec").onclick = ()=>{
      if (recognition){
        recognition.stop();
        console.log("Rozpoznawanie mowy: STOP");
      }
    };
  </script>
  <script type="module">
  import { GoogleGenAI } from "https://esm.run/@google/genai";

    // === GEMINI ===
    async function askGemini(modelName, text) {
      try {
          const token = document.getElementById('token').value.trim();
          if (!token) {
            alert("Podaj token API!");
            return;
          }
          const ai = new GoogleGenAI({ apiKey: token });
            const result = await ai.models.generateContent({
                model: modelName,
                contents: text,
            });

        return result.text;
      } catch (err) {
        console.error("B≈ÇƒÖd Gemini:", err);
        return "‚ùå B≈ÇƒÖd podczas komunikacji z API Gemini.";
      }
    }

      // ok
      function speak(text){
        const utter = new SpeechSynthesisUtterance(text);
        const selectedOption = voiceSelect.selectedOptions[0]?.getAttribute("data-name");
        if (selectedOption){
          const v = voices.find(v=>v.name===selectedOption);
          if (v) utter.voice = v;
        }
        synth.speak(utter);
      }

      // ok
      answerBtn.onclick = async ()=>{
        const query = inputTxt.value.trim();
        if (!query) return;
        const modelName = modelSelect.value;
        inputTxt.value = "‚è≥ Wysy≈Çam do Gemini...";
        const resp = await askGemini(modelName, query);
        inputTxt.value = resp;
        speak(resp);
      };

      // querry preprocess

      // querry postprocess

  </script>
</body>
</html>
