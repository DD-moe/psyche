<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Przepytam CiÄ™ ze Skali Glasgow</title>
  <link rel="stylesheet" href="https://git.1ioe.top/psyche/simulator_v2/styles.css">

</head>
<body>
  <h1>Przepytam CiÄ™ ze Skali Glasgow</h1>
  <label for="token">Token (API Key):</label>
  <input type="password" id="token" placeholder="WprowadÅº swÃ³j token...">
  <hr>

  <button id="generateBtn">Generuj przypadek</button>
  <div id="loadingSpinner" style="display:none; text-align:center; margin: 10px;">
    <span style="display:inline-block; width:24px; height:24px; border:4px solid #ccc; border-top-color:#005691; border-radius:50%; animation: spin 1s linear infinite;"></span>
  </div>
  <p><strong>Wygenerowany przypadek:</strong></p>
  <pre id="caseOutput">[Brak przypadku]</pre>

  <hr>
    <p>Podaj ile punktÃ³w w skali Glasgow ma dany pacjent</p>
  <hr>

  <label for="userInput">Napisz status praesens:</label><br>
  <textarea id="userInput" rows="10" cols="80"></textarea><br>

  <button id="evaluateBtn">OceÅ„</button>
  <div id="evaluatingSpinner" style="display:none; text-align:center; margin: 10px;">
    <span style="display:inline-block; width:24px; height:24px; border:4px solid #ccc; border-top-color:#005691; border-radius:50%; animation: spin 1s linear infinite;"></span>
  </div>
  <p><strong>Ocena AI:</strong></p>
  <pre id="evaluationOutput">[Brak oceny]</pre>

<script type="module">
  import { GoogleGenAI } from "https://esm.run/@google/genai";

  async function main(prompt, instruction, token) {
    const ai = new GoogleGenAI({ apiKey: token });

    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: prompt,
      config: {
        systemInstruction: instruction,
      },
    });

    return response.text || "[Brak odpowiedzi]";
  }

  let lastCase = '';
  const schemaInstrukcja = `<GlasgowComaScale>
Punkty: 6
- Otwieranie oczu: (brak danych)
- Reakcja sÅ‚owna: (brak danych)
- OdpowiedÅº ruchowa: odpowiednia do polecenia

Punkty: 5
- Otwieranie oczu: (brak danych)
- Reakcja sÅ‚owna: peÅ‚na orientacja
- OdpowiedÅº ruchowa: celowa

Punkty: 4
- Otwieranie oczu: spontaniczne
- Reakcja sÅ‚owna: mowa chaotyczna
- OdpowiedÅº ruchowa: ruch ucieczki na bÃ³l

Punkty: 3
- Otwieranie oczu: na gÅ‚os, zawoÅ‚anie
- Reakcja sÅ‚owna: mowa niewÅ‚aÅ›ciwa
- OdpowiedÅº ruchowa: zgiÄ™ciowa

Punkty: 2
- Otwieranie oczu: na bÃ³l
- Reakcja sÅ‚owna: niezrozumiaÅ‚e dÅºwiÄ™ki
- OdpowiedÅº ruchowa: wyprostna

Punkty: 1
- Otwieranie oczu: brak
- Reakcja sÅ‚owna: brak
- OdpowiedÅº ruchowa: brak
`;

function ll(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}


  document.getElementById('generateBtn').addEventListener('click', async () => {
    const token = document.getElementById('token').value.trim();
    if (!token) {
      alert("Podaj token API!");
      return;
    }

    const instruction = `Wygeneruj na podstawie schematu opisowy stan pacjenta wg glasgow coma scale. Podaj tylko 3 parametry opisowe adekwatne do numeracji dla danej kategorii: otwieranie oczu: ${ll(1,4)} reakcja sÅ‚owna: ${ll(1,5)} odpowiedÅº ruchowa: ${ll(1,4)} `;
    const prompt = schemaInstrukcja;

    try {
      ss('loadingSpinner');
      lastCase = await main(prompt, instruction, token);
      document.getElementById('caseOutput').textContent = formatGlasgowTextForPre(lastCase);
    } catch (err) {
      document.getElementById('caseOutput').textContent = "BÅ‚Ä…d: " + err.message;
    }
    finally{
      hs('loadingSpinner');
    }
  });

  document.getElementById('evaluateBtn').addEventListener('click', async () => {
    const token = document.getElementById('token').value.trim();
    if (!token) {
      alert("Podaj token API!");
      return;
    }

    const userText = document.getElementById('userInput').value;
    const evaluationInstruction = "OceÅ„, czy uÅ¼ytkownik poprawnie podaÅ‚ stan pacjenta w skali glasgow - podaje numer. wrazie niepoprawnoÅ›ci podaj poprawnÄ… odpowiedÅº i wyjaÅ›nienie.";
    const schema = schemaInstrukcja;
    const prompt = `Opis pacjenta: ${userText}\n\nSchemat: ${schema}\n\nPrzypadek: ${lastCase}`;

    try {
      ss('evaluatingSpinner');
      const result = await main(prompt, evaluationInstruction, token);
      document.getElementById('evaluationOutput').textContent = formatGlasgowTextForPre(result);
    } catch (err) {
      document.getElementById('evaluationOutput').textContent = "BÅ‚Ä…d: " + err.message;
    }
    finally{
      hs('evaluatingSpinner');
    }
  });

  function formatGlasgowTextForPre(input) {
    // ZamieÅ„ podwÃ³jne gwiazdki na duÅ¼e litery lub styl ASCII
    let output = input
        .replace(/\*\*(.*?)\*\*/g, (match, p1) => p1.toUpperCase()) // **tekst** â†’ TEKST
        .replace(/\*   /g, "- ") // ZamieÅ„ wypunktowanie Markdown na myÅ›lniki
        .replace(/^\s*\n/gm, "") // UsuÅ„ puste linie

    // Dodaj wciÄ™cia i uporzÄ…dkuj
    return output.split('\n').map(line => '  ' + line.trim()).join('\n');
}

function ss(p){
  document.getElementById(p).style.display = 'block'; // ðŸ”¹ PokaÅ¼ spinner
}

function hs(p){
  document.getElementById(p).style.display = 'none'; // ðŸ”» Ukryj spinner
}

</script>

</body>
</html>
