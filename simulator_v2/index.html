<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Przepytam Cię ze Skali Glasgow</title>
  <style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background-color: #f4f7fa;
    color: #333;
    padding: 20px;
    max-width: 900px;
    margin: auto;
  }

  h1 {
    text-align: center;
    color: #005691;
  }

  label {
    font-weight: bold;
    display: block;
    margin-top: 20px;
  }

  input[type="password"] {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 6px;
  }

  textarea {
    width: 100%;
    padding: 10px;
    box-sizing: border-box;
    margin-top: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    resize: vertical;
    font-family: 'Segoe UI', sans-serif;
    font-size: 14px;
  }

  button {
    background-color: #005691;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    margin-top: 10px;
    margin-bottom: 10px;
  }

  button:hover {
    background-color: #004270;
  }

  pre {
    background-color: #eef2f7;
    border: 1px solid #ccc;
    padding: 12px;
    border-radius: 6px;
    white-space: pre-wrap;
    font-family: Consolas, monospace;
    margin-top: 5px;
  }

  hr {
    border: none;
    border-top: 1px solid #ccc;
    margin: 30px 0;
  }

  p strong {
    display: block;
    margin-top: 10px;
    margin-bottom: 5px;
  }
</style>

</head>
<body>
  <h1>Przepytam Cię ze Skali Glasgow</h1>
  <label for="token">Token (API Key):</label>
  <input type="password" id="token" placeholder="Wprowadź swój token...">
  <hr>

  <button id="generateBtn">Generuj przypadek</button>
  <p><strong>Wygenerowany przypadek:</strong></p>
  <pre id="caseOutput">[Brak przypadku]</pre>

  <hr>

  <label for="userInput">Napisz status praesens:</label><br>
  <textarea id="userInput" rows="10" cols="80"></textarea><br>

  <button id="evaluateBtn">Oceń</button>
  <p><strong>Ocena AI:</strong></p>
  <pre id="evaluationOutput">[Brak oceny]</pre>

<script type="module">
  import { GoogleGenAI } from "https://esm.run/@google/genai";

  async function main(prompt, instruction, token) {
    const ai = new GoogleGenAI({ apiKey: token });

    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: prompt,
      config: {
        systemInstruction: instruction,
      },
    });

    return response.text || "[Brak odpowiedzi]";
  }

  let lastCase = '';
  const schemaInstrukcja = `<GlasgowComaScale>
Punkty: 6
- Otwieranie oczu: (brak danych)
- Reakcja słowna: (brak danych)
- Odpowiedź ruchowa: odpowiednia do polecenia

Punkty: 5
- Otwieranie oczu: (brak danych)
- Reakcja słowna: pełna orientacja
- Odpowiedź ruchowa: celowa

Punkty: 4
- Otwieranie oczu: spontaniczne
- Reakcja słowna: mowa chaotyczna
- Odpowiedź ruchowa: ruch ucieczki na ból

Punkty: 3
- Otwieranie oczu: na głos, zawołanie
- Reakcja słowna: mowa niewłaściwa
- Odpowiedź ruchowa: zgięciowa

Punkty: 2
- Otwieranie oczu: na ból
- Reakcja słowna: niezrozumiałe dźwięki
- Odpowiedź ruchowa: wyprostna

Punkty: 1
- Otwieranie oczu: brak
- Reakcja słowna: brak
- Odpowiedź ruchowa: brak
`;

function ll(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}


  document.getElementById('generateBtn').addEventListener('click', async () => {
    const token = document.getElementById('token').value.trim();
    if (!token) {
      alert("Podaj token API!");
      return;
    }

    const instruction = `Wygeneruj na podstawie schematu opisowy stan pacjenta wg glasgow coma scale. Podaj tylko 3 parametry opisowe adekwatne do numeracji dla danej kategorii: otwieranie oczu: ${ll(1,4)} reakcja słowna: ${ll(1,5)} odpowiedź ruchowa: ${ll(1,4)} `;
    const prompt = schemaInstrukcja;

    try {
      lastCase = await main(prompt, instruction, token);
      document.getElementById('caseOutput').textContent = formatGlasgowTextForPre(lastCase);
    } catch (err) {
      document.getElementById('caseOutput').textContent = "Błąd: " + err.message;
    }
  });

  document.getElementById('evaluateBtn').addEventListener('click', async () => {
    const token = document.getElementById('token').value.trim();
    if (!token) {
      alert("Podaj token API!");
      return;
    }

    const userText = document.getElementById('userInput').value;
    const evaluationInstruction = "Oceń, czy użytkownik poprawnie podał stan pacjenta w skali glasgow - podaje numer. wrazie niepoprawności podaj poprawną odpowiedź i wyjaśnienie.";
    const schema = schemaInstrukcja;
    const prompt = `Opis pacjenta: ${userText}\n\nSchemat: ${schema}\n\nPrzypadek: ${lastCase}`;

    try {
      const result = await main(prompt, evaluationInstruction, token);
      document.getElementById('evaluationOutput').textContent = formatGlasgowTextForPre(result);
    } catch (err) {
      document.getElementById('evaluationOutput').textContent = "Błąd: " + err.message;
    }
  });

  function formatGlasgowTextForPre(input) {
    // Zamień podwójne gwiazdki na duże litery lub styl ASCII
    let output = input
        .replace(/\*\*(.*?)\*\*/g, (match, p1) => p1.toUpperCase()) // **tekst** → TEKST
        .replace(/\*   /g, "- ") // Zamień wypunktowanie Markdown na myślniki
        .replace(/^\s*\n/gm, "") // Usuń puste linie

    // Dodaj wcięcia i uporządkuj
    return output.split('\n').map(line => '  ' + line.trim()).join('\n');
}

</script>

</body>
</html>
