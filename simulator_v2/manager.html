<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Manager scenariuszy</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
      text-align: center;
      color: #333;
    }
    button {
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      margin: 10px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s ease;
    }
    button:hover {
      background: #115293;
      transform: translateY(-2px);
    }
    textarea {
      width: 90%;
      height: 120px;
      margin: 10px auto;
      display: block;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <h2>Manager scenariuszy</h2>

  <label>Nazwa zakładki: <input type="text" id="iframeNameInput" value="iframe1"></label><br>
  <label>Nazwa managera scenariuszy: <input type="text" id="managerNameInput" value="Manager"></label><br>
  <button id="openIframeBtn">rozpocznij scenariusz</button>

  <hr>

  <textarea id="pointsInput" placeholder="Wklej JSON punktów"></textarea>
  <input type="text" id="imageUrlInput" placeholder="URL obrazu">
  <br>
  <label>Zasięg kliknięcia w px: <input type="number" id="rangeInput" value="20"></label>
  <br>
  <button id="sendDataBtn">zastosuj zmiany</button>

  <h4>Podgląd obrazu</h4>
  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a9/Example.jpg/800px-Example.jpg" id="prevImage">

  <script>
    const bc = new BroadcastChannel("Main_channel");
    const prevImage = document.getElementById("prevImage");

    let iframeName = "";
    let managerName = "";

    // Otwórz nową zakładkę / okno z iframe
    document.getElementById("openIframeBtn").addEventListener("click", () => {
      iframeName = document.getElementById("iframeNameInput").value.trim() || "iframe1";
      managerName = document.getElementById("managerNameInput").value.trim() || "Manager";

      const url = `https://git.1ioe.top/psyche/simulator_v2/clicker.html#iframeName=${encodeURIComponent(iframeName)}&managerName=${encodeURIComponent(managerName)}`;
      iframeWindow = window.open(url, "_blank");
    });

    // Wyślij obraz i punkty
    document.getElementById("sendDataBtn").addEventListener("click", () => {
      const pointsJson = document.getElementById("pointsInput").value;
      const imageUrl = document.getElementById("imageUrlInput").value.trim();
      const range = parseInt(document.getElementById("rangeInput").value);
      setUpClicker(pointsJson, imageUrl, range);
    });

    // setup clicker
    function setUpClicker(points, imageUrl, range){
        if (!iframeName || !managerName) {
            alert("Najpierw otwórz iframe.");
            return;
        }

        try {
            // Wyślij punkty
            bc.postMessage({
            target: iframeName,
            from: managerName,
            task: "set points",
            content: points
            });
        } 
        catch(e) {
            alert("Nieprawidłowy JSON punktów");
        }

        if (imageUrl) {
            // Wyślij obraz
            bc.postMessage({
            target: iframeName,
            from: managerName,
            task: "set image",
            content: imageUrl
            });
            prevImage.src = imageUrl;
        }

        bc.postMessage({
            target: iframeName,
            from: managerName,
            task: "set range",
            content: range
        });
    }

    // setup in scenario
    function setUpScenario(app){
        const setup = scenario[app];
    }

    // Odbiór wiadomości z iframe (np. kliknięte punkty lub eksport)
    bc.onmessage = (event) => {
      const msg = event.data;
      if (!msg || typeof msg !== "object") return;
      if (msg.target !== managerName) return;

      switch(msg.task) {
        case "clicked points":
          console.log("Iframe kliknięte punkty:", msg.content);
          break;
        case "export points":
          console.log("Iframe wyeksportowane punkty:", msg.content);
          break;
        case "loaded image": 
          prevImage.src = msg.content;
          break;
        case "set search range":
          console.log("zmieniono zasięg na:", msg.content);
          break;
        case "setup me":
          //setUpScenario(msg.from);
          console.log(msg.from);
        default:
          console.warn("Nieznany task od iframe:", msg.task);
      }
    };
  </script>
</body>
</html>
