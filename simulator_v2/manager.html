<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Manager scenariuszy</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
      text-align: center;
      color: #333;
    }
    button {
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 10px 20px;
      margin: 10px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s ease;
    }
    button:hover {
      background: #115293;
      transform: translateY(-2px);
    }
    textarea {
      width: 90%;
      height: 120px;
      margin: 10px auto;
      display: block;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <h2>Manager scenariuszy</h2>
  <hr>
  <!-- clicker test -->

  <h3 id="clickerTestHeader">Clicker test - rozwiń</h3>
  <div id="clickerTestTab" style="display: none;">
    <label>Nazwa zakładki: <input type="text" id="iframeNameInput" value="iframe1"></label><br>
    <label>Nazwa managera scenariuszy: <input type="text" id="managerNameInput" value="Manager"></label><br>
    <button id="openIframeBtn">rozpocznij scenariusz</button>
    <hr>
    <textarea id="pointsInput" placeholder="Wklej JSON punktów"></textarea>
    <input type="text" id="imageUrlInput" placeholder="URL obrazu">
    <br>
    <label>Zasięg kliknięcia w px: <input type="number" id="rangeInput" value="20"></label>
    <br>
    <button id="sendDataBtn">zastosuj zmiany</button>

    <h4>Podgląd obrazu</h4>
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a9/Example.jpg/800px-Example.jpg" id="prevImage">
  </div>
  <!-- clicker test -->
  <hr>
  <!-- scenario -->
    <h3>Scenariusz</h3>
    <button id="startScenarioBtn">Rozpocznij scenariusz</button>
    <button id="loadScenarioBtn">Załaduj scenariusz</button>
    <button id="saveScenarioBtn">Zapisz scenariusz jako</button>
    <button id="newScenarioBtn">Nowy pusty scenariusz</button>
    <br><br>
    <label>Tu skpoiuj schemat ze scenariusza:</label>
    <textarea id="appsTextarea" placeholder="app1 - clicker, app2 - clicker, app3 - clickerSetup"></textarea>
    <input type="file" accept=".scen" id="scenarioSaver" style="display: none;">
    <hr>
    <h3>aplikacja</h3>
    <div id="apps"></div>
    <hr>
    <h3>Setup AI</h3>
    <textarea id="ClickerSetupDataset" placeholder="tu wpisz pełne dane z odnośnikami do punktów"></textarea>
    <textarea id="ClickerSetupExample" placeholder="tu wpisz w formacie {grupa przykładów:[przykład1, przykład2...],}"></textarea>
    <textarea id="ClickerSetupSchema" placeholder="tu wpisz schemat tworzenia pytania"></textarea>

  <script>
    const bc = new BroadcastChannel("Main_channel"); // broadcast channel for entire app

    const prevImage = document.getElementById("prevImage");
    const startScenarioBtn = document.getElementById("startScenarioBtn");
    const loadScenarioBtn = document.getElementById("loadScenarioBtn");
    const saveScenarioBtn = document.getElementById("saveScenarioBtn");
    const newScenarioBtn = document.getElementById("newScenarioBtn");
    const appsTextarea   = document.getElementById("appsTextarea");
    const scenarioSaver = document.getElementById("scenarioSaver");
    const apps = document.getElementById("apps");

    const header = document.getElementById("clickerTestHeader");
    const content = document.getElementById("clickerTestTab");

    let iframeName = ""; // iframe name for testing purpose
    let managerName = ""; // manager name - do not change
    let scenario; // keeps current scenario
    let setup; // keeps schema as key in scenario
    let step = 0; // krok w pętli odpytywania

    // rozwijanie/zwijanie zakładki do testów
    header.addEventListener("click", () => {
    if (content.style.display === "none") {
        content.style.display = "block";
        header.textContent = "▼ Clicker test - zwiń"; // zmiana tekstu + emoji
    } else {
        content.style.display = "none";
        header.textContent = "▶ Clicker test - rozwiń"; // zmiana tekstu + emoji
    }
    });

    // Otwórz nową zakładkę / okno z iframe
    document.getElementById("openIframeBtn").addEventListener("click", () => {
      iframeName = document.getElementById("iframeNameInput").value.trim() || "iframe1";
      managerName = document.getElementById("managerNameInput").value.trim() || "Manager";
      openTab(iframeName, managerName);
    });

    // open tab API
    function openTab(iframeName, managerName){
      const url = `https://git.1ioe.top/psyche/simulator_v2/clicker.html#iframeName=${encodeURIComponent(iframeName)}&managerName=${encodeURIComponent(managerName)}`;
      window.open(url, "_blank");
    }

    // Wyślij obraz i punkty
    document.getElementById("sendDataBtn").addEventListener("click", () => {
      iframeName = document.getElementById("iframeNameInput").value.trim() || "iframe1";
      managerName = document.getElementById("managerNameInput").value.trim() || "Manager";
      const pointsJson = document.getElementById("pointsInput").value;
      const imageUrl = document.getElementById("imageUrlInput").value.trim();
      const range = parseInt(document.getElementById("rangeInput").value);
      setUpClicker(iframeName, pointsJson, imageUrl, range);
    });

    // setup clicker
    function setUpClicker(iframeName, points, imageUrl, range){
        if (!iframeName || !managerName) {
            alert("Najpierw otwórz iframe.");
            return;
        }

        try {
            // Wyślij punkty
            bc.postMessage({
            target: iframeName,
            from: managerName,
            task: "set points",
            content: points
            });
        } 
        catch(e) {
            alert("Nieprawidłowy JSON punktów");
        }

        if (imageUrl) {
            // Wyślij obraz
            bc.postMessage({
            target: iframeName,
            from: managerName,
            task: "set image",
            content: imageUrl
            });
            prevImage.src = imageUrl;
        }

        bc.postMessage({
            target: iframeName,
            from: managerName,
            task: "set range",
            content: range
        });
    }

    // setup in scenario
    function setUpScenario(app){
        const setup = scenario[app];
        setUpClicker(app, JSON.stringify(setup.points), setup.imageUrl, setup.range);
    }

    // prepare scenario
    function prepareScenario(scenarioObj) 
    { 
        // parametry wyboru scenariusza
        let clickers = 0;

        // pobierz nazwę managera 
        managerName = document.getElementById("managerNameInput").value.trim() || "Manager";
        // wyczyść poprzednie linki (opcjonalnie) 
        apps.innerHTML = "";
        // iteracja po wszystkich aplikacjach
        Object.keys(scenarioObj).forEach(appName => {
            appType = scenarioObj[appName].type;  // type of each app "actor" in scenario
            switch (appType) {
                case "clicker": // tylko dla clickera
                    // przygotuj link do clicker.html z parametrami
                    const url = `clicker.html#iframeName=${encodeURIComponent(appName)}&managerName=${encodeURIComponent(managerName)}`;
                    // utwórz element <a>
                    const a = document.createElement("a");
                    a.href = url;
                    a.textContent = `Otwórz ${appName}`; 
                    a.target = "_blank";
                    // otwiera w nowej karcie, usuń jeśli chcesz w tej samej 
                    a.style.display = "block";
                    // żeby linki były jeden pod drugim  dodaj link do kontenera 
                    apps.appendChild(a);       
                    clickers ++;              
                    break;
            
                default: // gdy nieznany typ
                    console.log("Nieznany typ app");
                    break;
            }
        }); 
        // sprawdza który scenariusz pasuje do typów aplikacji - jeśli pasuje - otwiera go
        if (clickers === 1) {
            window.open("https://git.1ioe.top/psyche/simulator_v2/iframe_map.html", "_blank");
        }
        step = 0;
        odpytanie("start");
    }


    // save points to scenario to given app
    function scenarioEditPoints(from, points){
        scenario[from].points = points;
    }

    // save image to scenario to given app
    function scenarioEditImage(from, imageUrl){
        scenario[from].imageUrl = imageUrl;
    }

    // save range to scenario to given app
    function scenarioEditRange(from, range){
        scenario[from].range = range;
    }

    // Funkcja do otwierania pliku (tylko .scen)
    loadScenarioBtn.addEventListener("click", async () => {
        scenarioSaver.click();
    });

    // zapisuje scenariusze gdzie trzeba - do zmiennej globalnej
    scenarioSaver.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const text = await file.text();
        try {
        scenario = JSON.parse(text); // zapisujemy do globalnej zmiennej
        alert("Załadowano scenariusz");
        console.log("Scenario:", scenario);
        } catch (err) {
        alert("Błąd parsowania pliku scenariusza: " + err.message);
        }
        step = 0; // po wczytaniu nowego scenariusza wszystko zaczyna się od poczatku
        
        // szukamy scenario by znaleźć clickerSetup i ustawić zmienna setup na ten key
        let apps = "";
        for (const key in scenario) {
            apps += `${key} - ${scenario[key].type}, `;
            if (
                Object.prototype.hasOwnProperty.call(scenario, key) &&
                scenario[key].type === "clickerSetup"
            ) {
                setup = key;
                document.getElementById('ClickerSetupDataset').value = scenario[setup].dataset;
                document.getElementById('ClickerSetupExample').value = JSON.stringify(scenario[setup].examples, null, 2);
                document.getElementById('ClickerSetupSchema').value = scenario[setup].schema;
                break; // zatrzymujemy się na pierwszym znalezionym
            }
        }
        appsTextarea.value = apps;
    };

    // Funkcja do zapisywania scenariusza
    saveScenarioBtn.addEventListener("click", async () => {
    try {
        const json = JSON.stringify(scenario, null, 2);

        // 1. Pokazujemy dialog „Zapisz jako…”
        const fileHandle = await window.showSaveFilePicker({
        suggestedName: "scenario.scen",       // domyślna nazwa
        types: [
            {
            description: "Pliki scenariuszy",
            accept: { "application/json": [".scen"] }
            }
        ]
        });

        // 2. Otwieramy plik do zapisu
        const writable = await fileHandle.createWritable();

        // 3. Zapisujemy zawartość
        await writable.write(json);

        // 4. Kończymy zapis
        await writable.close();

        alert("Scenariusz zapisany pomyślnie!");
    } catch (err) {
        if (err.name !== 'AbortError') {
        console.error("Błąd zapisu pliku scenariusza:", err);
        }
    }
    });

    // Funkcja startu scenariusza
    startScenarioBtn.addEventListener("click", () => {
    if (!scenario || Object.keys(scenario).length === 0) {
        alert("Brak scenariusza!");
        return;
    }
    // tu odpalasz swoją funkcję
    prepareScenario(scenario);
    });   

    // Nowy pusty scenariusz na podstawie textarea
    newScenarioBtn.addEventListener("click", () => {
        const apps = appsTextarea.value
            .split(",")
            .map(s => s.trim())
            .filter(Boolean);

        scenario = {}; // resetujemy

        apps.forEach(entry => {
            // rozdziel nazwę i typ po znaku '-'
            const parts = entry.split("-").map(p => p.trim());
            const appName = parts[0];
            const appType = parts[1];

            switch (appType) {
                case "clicker":  // tworzy clicker
                    scenario[appName] = {
                        points: [],
                        imageUrl: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a9/Example.jpg/800px-Example.jpg",
                        range: 20,
                        type: appType
                    };                    
                    break;
                case "clickerSetup":
                    scenario[appName] = {
                        type: appType,
                        dataset: document.getElementById('ClickerSetupDataset').value, // pełem zestaw danych - ocena i układanie pytania
                        examples: JSON.parse(document.getElementById('ClickerSetupExample').value), // obiekt key - grupa przykładów = array
                        schema: document.getElementById('ClickerSetupSchema').value
                    }; 
                    setup = appName;
                default:
                    break;
            }
        });

        console.log(scenario); // podgląd w konsoli
    });

    // Funkcja aktualizująca scenario[clickerSetup]
    function updateSetup() {
    scenario[setup].dataset  = document.getElementById('ClickerSetupDataset').value;
    scenario[setup].examples = JSON.parse(document.getElementById('ClickerSetupExample').value);
    scenario[setup].schema   = document.getElementById('ClickerSetupSchema').value;

    console.log('Zaktualizowano scenario.setup:', scenario[setup]);
    }

    // Dodajemy event listenery na "input" (działa przy każdej zmianie)
    document.getElementById('ClickerSetupDataset').addEventListener('input', updateSetup);
    document.getElementById('ClickerSetupExample').addEventListener('input', updateSetup);
    document.getElementById('ClickerSetupSchema').addEventListener('input', updateSetup);

    // odpytanie
    async function odpytanie(clickedPoints){
        if (step === 0) { // zaczynamy od pytania
            const question = pytanie(); // prompt do ai na ułożenie pytania 
            alert(question);
        }
    }

    // zamienia <> na losowy key z exampleObj
    function generateQuestion(exampleObj, schema) {
    const randFromArray = arr => arr[Math.floor(Math.random() * arr.length)];

    // Bezpiecznie konwertuje na string (jeśli trzeba)
    function ensureString(v) {
        if (typeof v === 'string') return v;
        if (v === undefined || v === null) return '';
        try { return JSON.stringify(v); } catch (e) { return String(v); }
    }

    // Zamienia wszystkie wystąpienia <GroupName> w str na losowe elementy exampleObj[groupName].
    // Zwraca { newStr, replaced } - replaced = true jeśli którakolwiek zamiana zmieniła <...>.
    function replaceAngles(str) {
        str = ensureString(str);
        const angleRegex = /<([^>]+)>/g;
        let replacedAny = false;

        const newStr = str.replace(angleRegex, (match, groupName) => {
        const key = groupName.trim();
        if (
            exampleObj &&
            Object.prototype.hasOwnProperty.call(exampleObj, key) &&
            Array.isArray(exampleObj[key]) &&
            exampleObj[key].length > 0
        ) {
            let chosen = randFromArray(exampleObj[key]);
            // upewniamy się, że wstawiamy string
            chosen = ensureString(chosen);
            if (chosen !== match) replacedAny = true; // match to "<GroupName>"
            return chosen;
        } else {
            // Nie znamy grupy -> zostawiamy tag bez zmiany
            return match;
        }
        });

        return { newStr, replaced: replacedAny };
    }

    // Główna pętla: powtarzamy zamiany dopóki coś się rzeczywiście zmienia
    let current = ensureString(schema);
    const MAX_ITER = 50; // limit bezpieczeństwa na zagnieżdżenia
    let iter = 0;

    while (true) {
        const { newStr, replaced } = replaceAngles(current);
        if (!replaced) break; // nic realnie nie zamieniliśmy -> koniec
        current = newStr;
        iter++;
        if (iter >= MAX_ITER) {
        console.warn('generateQuestion: osiągnięto maksymalną liczbę iteracji, przerwanie');
        break;
        }
    }

    return current;
    }

    // generuje szablon pytania na podstawie przykładów, bazy danych i schematu pytania
    function pytanie(){
        // formowanie wzoru pytania
        const pattern = generateQuestion(scenario[setup].dataset, scenario[setup].examples); // wzór pytania

        // formowanie pytania
        const question = `Poniżej znajduje się zestaw danych, z którego odpytujsz użytkownika:
        \n
        ${scenario[setup].dataset}
        \n
        Zadaj użytnikowi pyytanie, parafrazując pytanie przygotowane przez algorytm:
        \n
        ${pattern}
        \n
        napisz tylko sparafrazowane pytanie - nic więcej.`;

        return question;
    }

    // Odbiór wiadomości z iframe (np. kliknięte punkty lub eksport)
    bc.onmessage = (event) => {
      const msg = event.data;
      if (!msg || typeof msg !== "object") return;
      if (msg.target !== managerName) return;

      switch(msg.task) {
        case "clicked points":
          console.log("Iframe kliknięte punkty:", msg.content);
          odpytanie(msg.content);
          break;
        case "export points":
          console.log(msg.from, msg.content);
          scenarioEditPoints(msg.from, msg.content); // when exporting points finishes setup is done to specific scenario app
          break;
        case "loaded image": 
          console.log(msg.from, msg.content);        
          scenarioEditImage(msg.from, msg.content); // when loading image is done it saves image url to specific scenario app
          prevImage.src = msg.content;
          break;
        case "set search range":
          console.log(msg.from, msg.content);            
          scenarioEditRange(msg.from, msg.content); // when setting range is done it saves range to specific scenario app
          break;
        case "setup me":
          console.log(msg.from, msg.content);            
          setUpScenario(msg.from); // when app is ready requests for sending setup to it
          break;
        default:
          console.warn("Nieznany task od iframe:", msg.task);
      }
    };
  </script>
</body>
</html>
