<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Przepytam Ciƒô z norm labolatoryjnych</title>
  <link rel="stylesheet" href="https://git.1ioe.top/psyche/simulator_v2/styles.css">

</head>
    <body>
    <h1>Przepytam Ciƒô z norm labolaoryjnych</h1>
    <label for="token">Token (API Key):</label>
    <input type="password" id="token" placeholder="Wprowad≈∫ sw√≥j token...">
    <hr>

    <button id="generateBtn">Generuj przypadek</button>
    <div id="loadingSpinner" style="display:none; text-align:center; margin: 10px;">
        <span style="display:inline-block; width:24px; height:24px; border:4px solid #ccc; border-top-color:#005691; border-radius:50%; animation: spin 1s linear infinite;"></span>
    </div> 
    <p><strong>Wygenerowany przypadek:</strong></p>
    <pre id="caseOutput">[Brak przypadku]</pre>

    <hr>
        <p>Podaj czy dana warto≈õƒá jest powy≈ºej czy poni≈ºej normy</p>
    <hr>

    <label for="userInput">Napisz odpowied≈∫:</label><br>
    <textarea id="userInput" rows="10" cols="80"></textarea><br>

    <button id="evaluateBtn">Oce≈Ñ</button>
    <div id="evaluatingSpinner" style="display:none; text-align:center; margin: 10px;">
        <span style="display:inline-block; width:24px; height:24px; border:4px solid #ccc; border-top-color:#005691; border-radius:50%; animation: spin 1s linear infinite;"></span>
    </div>    
    <p><strong>Ocena AI:</strong></p>
    <pre id="evaluationOutput">[Brak oceny]</pre>
    </body>

<script>
// definicja {dynamiczna} skali do odpytania
let definicja = ``;

// wygenerowany przypadek
let lastCase = '';

// zestaw parametr√≥w do tworzenia dynamicznej definicji
const defSet = [
  [
    "Hemoglobina: 12.0 - 16.0 g/dL (Norma dla kobiet; u mƒô≈ºczyzn 13.5 - 17.5 g/dL)",
    ["poni≈ºej normy", "w zakresie normy", "powy≈ºej normy"]
  ],
  [
    "Leukocyty (WBC): 4.0 - 10.0 tys/ŒºL (Norma og√≥lna dla doros≈Çych)",
    ["poni≈ºej normy", "w zakresie normy", "powy≈ºej normy"]
  ],
  [
    "Glukoza na czczo: 70 - 99 mg/dL (Wy≈ºsze warto≈õci mogƒÖ wskazywaƒá na stan przedcukrzycowy)",
    ["poni≈ºej normy", "w zakresie normy", "stan przedcukrzycowy", "cukrzyca"]
  ],
  [
    "Cholesterol ca≈Çkowity: < 190 mg/dL (Po≈ºƒÖdany poziom dla doros≈Çych)",
    ["w zakresie normy", "podwy≈ºszony poziom"]
  ],
  [
    "TSH: 0.4 - 4.0 ¬µIU/mL (Norma dla doros≈Çych; zale≈ºna od wieku i ciƒÖ≈ºy)",
    ["poni≈ºej normy", "w zakresie normy", "powy≈ºej normy"]
  ],
  [
    "Kreatynina: 0.5 - 1.1 mg/dL (Norma dla kobiet; u mƒô≈ºczyzn do 1.3 mg/dL)",
    ["poni≈ºej normy", "w zakresie normy", "powy≈ºej normy"]
  ],
  [
    "CRP: < 5 mg/L (Wska≈∫nik stanu zapalnego w organizmie)",
    ["w zakresie normy", "podwy≈ºszone"]
  ],
  [
    "≈ªelazo: 60 - 160 ¬µg/dL (Warto≈õci ni≈ºsze czƒôstsze u kobiet)",
    ["poni≈ºej normy", "w zakresie normy", "powy≈ºej normy"]
  ],
  [
    "ALT (GPT): 7 - 35 U/L (Norma dla kobiet; u mƒô≈ºczyzn do 45 U/L)",
    ["poni≈ºej normy", "w zakresie normy", "powy≈ºej normy"]
  ],
  [
    "P≈Çytki krwi (PLT): 150 - 400 tys/ŒºL (Norma dla doros≈Çych obu p≈Çci)",
    ["poni≈ºej normy", "w zakresie normy", "powy≈ºej normy"]
  ]
];


</script>

<script type="module">

  // importuje bibliotekƒô z google
  import { GoogleGenAI } from "https://esm.run/@google/genai";

  // funkcja do odpytywania AI
  async function main(prompt, instruction, token) {
    const ai = new GoogleGenAI({ apiKey: token });

    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: prompt,
      config: {
        systemInstruction: instruction,
      },
    });

    return response.text || "[Brak odpowiedzi]";
  }

  // funkcja do losowania definicji z zestawu
    function losujParametr(set) {
        const i = Math.floor(Math.random() * set.length);
        return set[i];
    }

  // przycisk do generowania przypadku
    document.getElementById('generateBtn').addEventListener('click', async () => {
    const token = document.getElementById('token').value.trim();
    if (!token) {
      alert("Podaj token API!");
      return;
    }
    // tworzy definicjƒô dynamicznƒÖ
    const dyn_def = losujParametr(defSet);
    definicja = dyn_def[0];
    const wariant = losujParametr(dyn_def[1]);
    const instruction = `Wygeneruj na podstawie definicji parametru labolatoryjnego warto≈õƒá, tak by by≈Ça ona prawdziwa dla wariantu: ${wariant}. Format odpowiedzi to: nazwa parametru (ewentualnie dopercyzowanie u kogo/ w jakich okoliczno≈õciach)  -  warto≈õƒá`;
    console.log(definicja, wariant);
    const prompt = definicja;

    try {
      ss('loadingSpinner'); 
      lastCase = await main(prompt, instruction, token);
      document.getElementById('caseOutput').textContent = formatResponse(lastCase);
    } catch (err) {
      document.getElementById('caseOutput').textContent = "B≈ÇƒÖd: " + err.message;
    }
    finally{
      hs('loadingSpinner');
    }      
  });

  // prcycisk do oceny przez AI
    document.getElementById('evaluateBtn').addEventListener('click', async () => {
    const token = document.getElementById('token').value.trim();
    if (!token) {
      alert("Podaj token API!");
      return;
    }

    const userText = document.getElementById('userInput').value;
    const evaluationInstruction = "Oce≈Ñ, czy u≈ºytkownik poprawnie oceni≈Ç czy dany parametr labolatoryjny jest w normie, czy te≈º powy≈ºej lub poni≈ºej. W razie niepoprawno≈õci podaj poprawnƒÖ odpowied≈∫ i wyja≈õnienie.";
    const schema = definicja;
    const prompt = `Opis pacjenta: ${userText}\n\nDefinicja Skali ASA: ${schema}\n\nPrzypadek: ${lastCase}`;

    try {
      ss('evaluatingSpinner');
      const result = await main(prompt, evaluationInstruction, token);
      document.getElementById('evaluationOutput').textContent = formatResponse(result);
    } catch (err) {
      document.getElementById('evaluationOutput').textContent = "B≈ÇƒÖd: " + err.message;
    }
    finally{
      hs('evaluatingSpinner');
    }    
  });

  // funkcja do formatowania odpowiedzi
    function formatResponse(input) {
    // Zamie≈Ñ podw√≥jne gwiazdki na du≈ºe litery lub styl ASCII
    let output = input
        .replace(/\*\*(.*?)\*\*/g, (match, p1) => p1.toUpperCase()) // **tekst** ‚Üí TEKST
        .replace(/\*   /g, "- ") // Zamie≈Ñ wypunktowanie Markdown na my≈õlniki
        .replace(/^\s*\n/gm, "") // Usu≈Ñ puste linie

    // Dodaj wciƒôcia i uporzƒÖdkuj
    return output.split('\n').map(line => '  ' + line.trim()).join('\n');
    }
    
function ss(p){
  document.getElementById(p).style.display = 'block'; // üîπ Poka≈º spinner
}

function hs(p){
  document.getElementById(p).style.display = 'none'; // üîª Ukryj spinner
}


</script>
</html>