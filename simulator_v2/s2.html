<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Przepytam Cię z norm labolatoryjnych</title>
  <style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background-color: #f4f7fa;
    color: #333;
    padding: 20px;
    max-width: 900px;
    margin: auto;
  }

  h1 {
    text-align: center;
    color: #005691;
  }

  label {
    font-weight: bold;
    display: block;
    margin-top: 20px;
  }

  input[type="password"] {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 6px;
  }

  textarea {
    width: 100%;
    padding: 10px;
    box-sizing: border-box;
    margin-top: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    resize: vertical;
    font-family: 'Segoe UI', sans-serif;
    font-size: 14px;
  }

  button {
    background-color: #005691;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    margin-top: 10px;
    margin-bottom: 10px;
  }

  button:hover {
    background-color: #004270;
  }

  pre {
    background-color: #eef2f7;
    border: 1px solid #ccc;
    padding: 12px;
    border-radius: 6px;
    white-space: pre-wrap;
    font-family: Consolas, monospace;
    margin-top: 5px;
  }

  hr {
    border: none;
    border-top: 1px solid #ccc;
    margin: 30px 0;
  }

  p strong {
    display: block;
    margin-top: 10px;
    margin-bottom: 5px;
  }
</style>

</head>
    <body>
    <h1>Przepytam Cię ze norm labolaoryjnych</h1>
    <label for="token">Token (API Key):</label>
    <input type="password" id="token" placeholder="Wprowadź swój token...">
    <hr>

    <button id="generateBtn">Generuj przypadek</button>
    <p><strong>Wygenerowany przypadek:</strong></p>
    <pre id="caseOutput">[Brak przypadku]</pre>

    <hr>
        <p>Podaj czy dana wartość jest powyżej czy poniżej normy</p>
    <hr>

    <label for="userInput">Napisz odpowiedź:</label><br>
    <textarea id="userInput" rows="10" cols="80"></textarea><br>

    <button id="evaluateBtn">Oceń</button>
    <p><strong>Ocena AI:</strong></p>
    <pre id="evaluationOutput">[Brak oceny]</pre>
    </body>

<script>
// definicja {dynamiczna} skali do odpytania
let definicja = ``;

// wygenerowany przypadek
let lastCase = '';

// zestaw parametrów do tworzenia dynamicznej definicji
const defSet = [
  "Hemoglobina: 12.0 - 16.0 g/dL (Norma dla kobiet; u mężczyzn 13.5 - 17.5 g/dL)",
  "Leukocyty (WBC): 4.0 - 10.0 tys/μL (Norma ogólna dla dorosłych)",
  "Glukoza na czczo: 70 - 99 mg/dL (Wyższe wartości mogą wskazywać na stan przedcukrzycowy)",
  "Cholesterol całkowity: < 190 mg/dL (Pożądany poziom dla dorosłych)",
  "TSH: 0.4 - 4.0 µIU/mL (Norma dla dorosłych; zależna od wieku i ciąży)",
  "Kreatynina: 0.5 - 1.1 mg/dL (Norma dla kobiet; u mężczyzn do 1.3 mg/dL)",
  "CRP: < 5 mg/L (Wskaźnik stanu zapalnego w organizmie)",
  "Żelazo: 60 - 160 µg/dL (Wartości niższe częstsze u kobiet)",
  "ALT (GPT): 7 - 35 U/L (Norma dla kobiet; u mężczyzn do 45 U/L)",
  "Płytki krwi (PLT): 150 - 400 tys/μL (Norma dla dorosłych obu płci)"
];

</script>

<script type="module">

  // importuje bibliotekę z google
  import { GoogleGenAI } from "https://esm.run/@google/genai";

  // funkcja do odpytywania AI
  async function main(prompt, instruction, token) {
    const ai = new GoogleGenAI({ apiKey: token });

    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: prompt,
      config: {
        systemInstruction: instruction,
      },
    });

    return response.text || "[Brak odpowiedzi]";
  }

  // funkcja do losowania definicji z zestawu
    function losujParametr(set) {
        const i = Math.floor(Math.random() * set.length);
        return set[i];
    }

  // przycisk do generowania przypadku
    document.getElementById('generateBtn').addEventListener('click', async () => {
    const token = document.getElementById('token').value.trim();
    if (!token) {
      alert("Podaj token API!");
      return;
    }
    // tworzy definicję dynamiczną
    definicja = losujParametr(defSet);
    const instruction = `Wygeneruj na podstawie definicji parametru labolatoryjnego wartość, wybierz losowo czy ma być powyżej, poniżej czy w normie. Format odpowiedzi to: nazwa parametru (ewentualnie dopercyzowanie u kogo/ w jakich okolicznościach)  -  wartość`;
    console.log(definicja);
    const prompt = definicja;

    try {
      lastCase = await main(prompt, instruction, token);
      document.getElementById('caseOutput').textContent = formatResponse(lastCase);
    } catch (err) {
      document.getElementById('caseOutput').textContent = "Błąd: " + err.message;
    }
  });

  // prcycisk do oceny przez AI
    document.getElementById('evaluateBtn').addEventListener('click', async () => {
    const token = document.getElementById('token').value.trim();
    if (!token) {
      alert("Podaj token API!");
      return;
    }

    const userText = document.getElementById('userInput').value;
    const evaluationInstruction = "Oceń, czy użytkownik poprawnie ocenił czy dany parametr labolatoryjny jest w normie, czy też powyżej lub poniżej. W razie niepoprawności podaj poprawną odpowiedź i wyjaśnienie.";
    const schema = definicja;
    const prompt = `Opis pacjenta: ${userText}\n\nDefinicja Skali ASA: ${schema}\n\nPrzypadek: ${lastCase}`;

    try {
      const result = await main(prompt, evaluationInstruction, token);
      document.getElementById('evaluationOutput').textContent = formatResponse(result);
    } catch (err) {
      document.getElementById('evaluationOutput').textContent = "Błąd: " + err.message;
    }
  });

  // funkcja do formatowania odpowiedzi
    function formatResponse(input) {
    // Zamień podwójne gwiazdki na duże litery lub styl ASCII
    let output = input
        .replace(/\*\*(.*?)\*\*/g, (match, p1) => p1.toUpperCase()) // **tekst** → TEKST
        .replace(/\*   /g, "- ") // Zamień wypunktowanie Markdown na myślniki
        .replace(/^\s*\n/gm, "") // Usuń puste linie

    // Dodaj wcięcia i uporządkuj
    return output.split('\n').map(line => '  ' + line.trim()).join('\n');
    }
</script>
</html>