<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Scanner — demo (z kamerą i klikaniem)</title>
  <style>
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      max-width:900px;margin:24px auto;padding:12px
    }
    h1{font-size:1.4rem}
    .card{
      padding:12px;border:1px solid #ddd;border-radius:8px;background:#fff
    }
    .video-wrap{
      position:relative;display:inline-block;width:100%;max-width:640px;
    }
    video{
      width:100%;border-radius:8px;cursor:pointer;
    }
    .overlay-text{
      position:absolute;top:0;left:0;right:0;bottom:0;
      display:flex;align-items:center;justify-content:center;
      color:white;font-size:1.2rem;text-shadow:0 0 8px #000;
      pointer-events:none;opacity:0.8;
    }
    textarea{
      width:100%;height:120px;padding:8px;margin-top:8px
    }
    .controls{display:flex;gap:8px;margin-top:8px}
    .error{color:#900;margin-top:8px}
    .hint{color:#555;margin-top:6px;font-size:0.95rem}
    button{
      padding:8px 12px;border-radius:6px;border:1px solid #888;
      background:#f8f8f8;cursor:pointer;
    }
  </style>
</head>
<body>
  <h1>Odczyt QR z kamery / zdjęcia — demo</h1>
  <p>Użyj lokalnej kamery lub wybierz zdjęcie z kodem QR. Kliknij wideo, aby wykonać skan. Po udanym odczycie kamera zostanie zatrzymana.</p>

  <div class="card">
    <h3>Podgląd kamery</h3>
    <div class="video-wrap">
      <video id="video" playsinline autoplay></video>
      <div class="overlay-text" id="overlayText">Kliknij, aby zeskanować</div>
    </div>

    <div class="controls">
      <button id="toggleCam">Uruchom kamerę</button>
      <input id="fileInput" type="file" accept="image/*" />
    </div>

    <canvas id="canvas" style="display:none"></canvas>

    <p>Odczytany tekst z QR:</p>
    <textarea id="out" placeholder="Tutaj pojawi się zawartość QR"></textarea>
    <div id="status" class="hint"></div>
    <div id="error" class="error" style="display:none"></div>
  </div>

  <!-- jsQR z CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const out = document.getElementById('out');
    const toggleCam = document.getElementById('toggleCam');
    const fileInput = document.getElementById('fileInput');
    const status = document.getElementById('status');
    const overlayText = document.getElementById('overlayText');
    let stream = null;
    let cameraOn = false;

    async function startCamera(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        video.srcObject = stream;
        await video.play();
        cameraOn = true;
        toggleCam.textContent = 'Zatrzymaj kamerę';
        status.textContent = 'Kamera uruchomiona. Kliknij obraz, aby zeskanować QR.';
      }catch(e){
        showError('Nie udało się uruchomić kamery: ' + e.message);
      }
    }

    function stopCamera(){
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream = null;
      }
      video.srcObject = null;
      cameraOn = false;
      toggleCam.textContent = 'Uruchom kamerę';
      status.textContent = 'Kamera zatrzymana.';
    }

    function showError(msg){
      const err = document.getElementById('error');
      err.style.display = 'block';
      err.textContent = msg;
      console.error(msg);
    }

    toggleCam.addEventListener('click', ()=>{
      if(cameraOn) stopCamera(); else startCamera();
    });

    // Kliknięcie w obraz - działa jak "zrób zdjęcie"
    video.addEventListener('click', ()=>{
      if(!cameraOn || video.readyState !== 4){
        alert('Kamera nie jest uruchomiona.');
        return;
      }
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      decodeCanvas();
    });

    // Wczytanie obrazu z pliku
    fileInput.addEventListener('change', (ev)=>{
      const file = ev.target.files[0];
      if(!file) return;
      const img = new Image();
      img.onload = ()=>{
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        ctx.drawImage(img,0,0);
        decodeCanvas();
      };
      img.onerror = ()=>alert('Nie można załadować pliku.');
      img.src = URL.createObjectURL(file);
    });

    function decodeCanvas(){
      if(typeof jsQR === 'undefined'){ showError('Dekoder jsQR niezaładowany.'); return; }

      try{
        const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'attemptBoth' });
        if(code){
          let text = code.data;
          try { text = decodeURIComponent(code.data); } catch(e){}
          out.value = text;
          drawBoundingBox(code.location);
          status.textContent = 'Kod QR odczytany pomyślnie!';
          stopCamera(); // zatrzymujemy kamerę po sukcesie
        } else {
          status.textContent = 'Nie znaleziono kodu QR. Spróbuj ponownie.';
        }
      }catch(e){
        showError('Błąd odczytu: ' + e.message);
      }
    }

    function drawBoundingBox(loc){
      const overlay = document.createElement('canvas');
      overlay.width = canvas.width;
      overlay.height = canvas.height;
      overlay.style.maxWidth = '100%';
      overlay.style.position = 'relative';
      overlay.style.pointerEvents = 'none';
      const octx = overlay.getContext('2d');
      octx.strokeStyle = 'lime';
      octx.lineWidth = 4;
      if(loc){
        octx.beginPath();
        octx.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
        octx.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
        octx.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
        octx.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
        octx.closePath();
        octx.stroke();
      }
      document.body.appendChild(overlay);
      setTimeout(()=>overlay.remove(), 1000);
    }
  </script>
</body>
</html>
