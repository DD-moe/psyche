<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Scanner — demo (poprawione)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;max-width:900px;margin:24px auto;padding:12px}
    h1{font-size:1.4rem}
    .card{padding:12px;border:1px solid #ddd;border-radius:8px;background:#fff}
    video, canvas{max-width:100%;border-radius:8px}
    textarea{width:100%;height:120px;padding:8px}
    .controls{display:flex;gap:8px;margin-top:8px}
    .error{color:#900;margin-top:8px}
    .hint{color:#555;margin-top:6px;font-size:0.95rem}
  </style>
</head>
<body>
  <h1>Odczyt QR z kamery / zdjęcia — demo (poprawione)</h1>
  <p>Ta strona używa lokalnej biblioteki <code>jsQR</code> (client-side) do odczytu kodu QR z obrazu — nie używa zewnętrznego API.</p>

  <div class="card">
    <h3>Podgląd kamery</h3>
    <video id="video" playsinline autoplay></video>
    <div class="controls">
      <button id="startCam">Start kamery</button>
      <button id="snap">Zrób zdjęcie</button>
      <input id="fileInput" type="file" accept="image/*" />
    </div>

    <canvas id="canvas" style="display:none"></canvas>

    <p style="margin-top:8px">Odczytany tekst z QR:</p>
    <textarea id="out" placeholder="Tutaj pojawi się zawartość QR"></textarea>
    <div id="status" class="hint"></div>
    <div id="error" class="error" style="display:none"></div>
  </div>

  <!-- biblioteka jsQR - upewniamy się, że ładowana przed naszym skryptem -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <script>
    // Proste sprawdzenie, czy biblioteka jsQR w ogóle się załadowała:
    if(typeof jsQR === 'undefined'){
      const e = document.getElementById('error');
      e.style.display = 'block';
      e.textContent = 'Błąd: biblioteka jsQR nie została załadowana. Sprawdź połączenie sieciowe lub CDN.';
      console.error('jsQR is not defined — upewnij się, że CDN jest dostępny i że tag <script> dla jsQR jest przed tym skryptem.');
      // dalej skrypt nie przerwie się (zabezpieczenie), ale próby dekodowania będą ignorowane
    }

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const out = document.getElementById('out');
    const startCam = document.getElementById('startCam');
    const snap = document.getElementById('snap');
    const fileInput = document.getElementById('fileInput');
    const status = document.getElementById('status');
    let stream = null;

    async function startCamera(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        video.srcObject = stream;
        await video.play();
        // ustaw canvas na wielkość video (po krótkim delay by video.videoWidth było ustawione)
        setTimeout(()=> {
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          status.textContent = 'Kamera uruchomiona. Możesz zrobić zdjęcie lub skanować automatycznie (opcjonalnie).';
        }, 200);
      }catch(e){
        const err = document.getElementById('error');
        err.style.display = 'block';
        err.textContent = 'Nie udało się uruchomić kamery: ' + e.message;
        console.error(e);
      }
    }

    startCam.addEventListener('click', ()=>{
      startCamera();
    });

    snap.addEventListener('click', ()=>{
      if(!video || video.readyState !== 4){
        alert('Kamera nie jest gotowa. Najpierw naciśnij "Start kamery".');
        return;
      }
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      decodeCanvas();
    });

    fileInput.addEventListener('change', (ev)=>{
      const file = ev.target.files[0];
      if(!file) return;
      const img = new Image();
      img.onload = ()=>{
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        ctx.drawImage(img,0,0);
        decodeCanvas();
      };
      img.onerror = ()=>alert('Nie można załadować pliku.');
      img.src = URL.createObjectURL(file);
    });

    function decodeCanvas(){
      // jeśli biblioteka nie jest dostępna, przerwij:
      if(typeof jsQR === 'undefined'){
        const err = document.getElementById('error');
        err.style.display = 'block';
        err.textContent = 'Dekoder QR nie jest dostępny (jsQR niezaładowane).';
        return;
      }

      try{
        const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
        // jsQR expects Uint8ClampedArray of RGBA data
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'attemptBoth' });
        if(code){
          // bezpieczne odkodowanie - jeśli dane były percent-encoded (encodeURIComponent) -> przywracamy
          let text = code.data;
          try {
            // jeśli code.data jest postaci percent-encoded to ta linia zadziała
            text = decodeURIComponent(code.data);
          } catch(e) {
            // jeśli decodeURIComponent rzuci błąd (np. nieprawidłowe sekwencje), użyjemy surowego tekstu
            console.warn('decodeURIComponent failed — using raw code.data', e);
            text = code.data;
          }
          out.value = text;
          drawBoundingBox(code.location);
          status.textContent = 'QR odczytany pomyślnie.';
        } else {
          out.value = '';
          status.textContent = 'Nie znaleziono kodu QR na obrazie.';
        }
      }catch(e){
        out.value = '';
        const err = document.getElementById('error');
        err.style.display = 'block';
        err.textContent = 'Błąd odczytu: ' + e.message;
        console.error(e);
      }
    }

    function drawBoundingBox(loc){
      const overlay = document.createElement('canvas');
      overlay.width = canvas.width;
      overlay.height = canvas.height;
      overlay.style.maxWidth = '100%';
      overlay.style.position = 'relative';
      overlay.style.pointerEvents = 'none';
      const octx = overlay.getContext('2d');
      octx.strokeStyle = 'red';
      octx.lineWidth = Math.max(2, Math.round(canvas.width/200));
      if(loc){
        octx.beginPath();
        octx.moveTo(loc.topLeftCorner.x, loc.topLeftCorner.y);
        octx.lineTo(loc.topRightCorner.x, loc.topRightCorner.y);
        octx.lineTo(loc.bottomRightCorner.x, loc.bottomRightCorner.y);
        octx.lineTo(loc.bottomLeftCorner.x, loc.bottomLeftCorner.y);
        octx.closePath();
        octx.stroke();
      }
      document.body.appendChild(overlay);
      setTimeout(()=>overlay.remove(), 1200);
    }

    // Opcjonalnie: automatyczny skaner co 800ms (odkomentuj jeśli chcesz)
    // let autoScanInterval = null;
    // function startAutoScan(){
    //   if(autoScanInterval) return;
    //   autoScanInterval = setInterval(()=> {
    //     if(video && video.readyState === 4){
    //       canvas.width = video.videoWidth;
    //       canvas.height = video.videoHeight;
    //       ctx.drawImage(video,0,0,canvas.width,canvas.height);
    //       decodeCanvas();
    //     }
    //   }, 800);
    // }
    // function stopAutoScan(){ clearInterval(autoScanInterval); autoScanInterval = null; }

  </script>
</body>
</html>
